<!-- filepath: /home/wush/playground/terraformer/README.md -->
# Terraformer Workspace Setup Guide

This repository contains Terraform configurations generated by Terraformer for AWS infrastructure.

## Prerequisites

### 1. Install AWS CLI

Install the AWS CLI v2:

```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

To update an existing installation:

```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install --bin-dir /usr/local/bin --install-dir /usr/local/aws-cli --update
```

### 2. Configure AWS Credentials

Run the AWS configuration wizard:

```bash
aws configure
```

You'll be prompted for:
- AWS Access Key ID
- AWS Secret Access Key
- Default region name (e.g., `ap-southeast-1`)
- Default output format

## Installation

### Install Terraformer

**Linux:**
```bash
export PROVIDER=all
curl -LO "https://github.com/GoogleCloudPlatform/terraformer/releases/download/$(curl -s https://api.github.com/repos/GoogleCloudPlatform/terraformer/releases/latest | grep tag_name | cut -d '"' -f 4)/terraformer-${PROVIDER}-linux-amd64"
chmod +x terraformer-${PROVIDER}-linux-amd64
sudo mv terraformer-${PROVIDER}-linux-amd64 /usr/local/bin/terraformer
```

**macOS:**
```bash
export PROVIDER=all
curl -LO "https://github.com/GoogleCloudPlatform/terraformer/releases/download/$(curl -s https://api.github.com/repos/GoogleCloudPlatform/terraformer/releases/latest | grep tag_name | cut -d '"' -f 4)/terraformer-${PROVIDER}-darwin-amd64"
chmod +x terraformer-${PROVIDER}-darwin-amd64
sudo mv terraformer-${PROVIDER}-darwin-amd64 /usr/local/bin/terraformer
```

**Package Managers:**
- Homebrew: `brew install terraformer`
- MacPorts: `sudo port install terraformer`
- Chocolatey (Windows): `choco install terraformer`

**Verify Installation:**
```bash
terraformer --version
```

### Install Terraform Providers

⚠️ **Important:** Terraformer requires the Terraform provider plugin to be installed before you can import resources.

#### Option A: Using `terraform init` (Recommended)

1. Create a working directory and `versions.tf` file:

```bash
mkdir -p ~/playground/terraformer/provider-setup
cd ~/playground/terraformer/provider-setup
```

2. Create `versions.tf` with the AWS provider configuration:

```bash
cat > versions.tf << 'EOF'
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.100.0"
    }
  }
  required_version = ">= 1.0"
}

provider "aws" {
  region = "ap-southeast-1"
}
EOF
```

3. Initialize Terraform to download the provider:

```bash
terraform init
```

4. Copy the provider to Terraformer's expected location:

```bash
mkdir -p ~/.terraform.d/plugins/linux_amd64
cp .terraform/providers/registry.terraform.io/hashicorp/aws/*/linux_amd64/terraform-provider-aws* \
   ~/.terraform.d/plugins/linux_amd64/
```

5. Verify the provider is installed:

```bash
ls -la ~/.terraform.d/plugins/linux_amd64/
```

#### Option B: Manual Download

Download the AWS provider binary directly:

1. Visit the [AWS Provider releases page](https://releases.hashicorp.com/terraform-provider-aws/)
2. Download the appropriate version for your system (linux_amd64)
3. Extract and move to the plugins directory:

```bash
mkdir -p ~/.terraform.d/plugins/linux_amd64
# Move the downloaded binary to ~/.terraform.d/plugins/linux_amd64/
```

#### Provider Links

For other cloud providers, download from these locations:

**Major Cloud:**
- [Google Cloud provider >2.11.0](https://releases.hashicorp.com/terraform-provider-google/)
- [AWS provider >2.25.0](https://releases.hashicorp.com/terraform-provider-aws/)
- [Azure provider >1.35.0](https://releases.hashicorp.com/terraform-provider-azurerm/)
- [Alicloud provider >1.57.1](https://releases.hashicorp.com/terraform-provider-alicloud/)

**Other Cloud:**
- [DigitalOcean provider >1.9.1](https://releases.hashicorp.com/terraform-provider-digitalocean/)
- [Heroku provider >2.2.1](https://releases.hashicorp.com/terraform-provider-heroku/)
- [Linode provider >1.8.0](https://releases.hashicorp.com/terraform-provider-linode/)

See [Terraformer documentation](https://github.com/GoogleCloudPlatform/terraformer#terraform-providers) for complete provider list.

## Using Terraformer

### Import AWS Resources

Once the provider is installed, you can import AWS resources:

**Start with a small test:**
```bash
cd ~/playground/terraformer

terraformer import aws \
  --resources=vpc \
  --connect=true \
  --profile=default \
  --regions=ap-southeast-1
```

**Import multiple resources:**
```bash
terraformer import aws \
  --resources=vpc,subnet,ec2_instance,s3 \
  --connect=true \
  --profile=default \
  --regions=ap-southeast-1
```

**Import all resources with custom output structure:**
```bash
terraformer import aws \
  --resources="*" \
  --regions=ap-southeast-1 \
  --profile=default \
  --path-output=generated \
  --path-pattern="{output}/{service}" \
  --connect=false
```

**Command Options Explained:**

- `--resources="*"`: Import all available AWS resources (vpc, ec2, s3, iam, rds, etc.)
  - ⚠️ **Warning**: This can take a very long time and generate hundreds of files
  - Alternative: Specify specific resources like `--resources=vpc,subnet,ec2_instance`

- `--regions=ap-southeast-1`: AWS region to import from
  - For multiple regions: `--regions=ap-southeast-1,us-east-1`

- `--profile=default`: AWS CLI profile to use (from `~/.aws/credentials`)
  - Use different profiles: `--profile=production`

- `--path-output=generated`: Base directory where files will be generated
  - Default is current directory
  - Creates structure: `generated/aws/vpc/`, `generated/aws/ec2/`, etc.

- `--path-pattern="{output}/{service}"`: Directory structure pattern
  - `{output}`: Expands to value of `--path-output` (e.g., `generated`)
  - `{service}`: Service name (e.g., `vpc`, `ec2_instance`, `iam`)
  - Result: `generated/vpc/`, `generated/ec2_instance/`, `generated/iam/`
  - Alternative patterns:
    - `"{output}/{region}/{service}"` → `generated/ap-southeast-1/vpc/`
    - `"{output}/terraform/{service}"` → `generated/terraform/vpc/`

- `--connect=false`: Don't connect resources with references
  - `--connect=true`: Creates Terraform references between resources (e.g., `vpc_id = aws_vpc.example.id`)
  - `--connect=false`: Each resource is independent (faster, but you'll need to manually link resources)
  - **Recommendation**: Use `false` for initial import, then refactor

**Import with filtering:**
```bash
# Import only specific VPC and its resources
terraformer import aws \
  --resources=vpc,subnet \
  --filter="vpc=id1:id2:id3" \
  --regions=ap-southeast-1 \
  --profile=default
```

**Import with resource tagging:**
```bash
# Import resources with specific tags
terraformer import aws \
  --resources=ec2_instance \
  --filter="ec2_instance=tags.Environment:production" \
  --regions=ap-southeast-1 \
  --profile=default
```

### Validate Generated Configuration

After importing, validate the generated Terraform files:

```bash
cd generated/vpc
terraform init
terraform plan
```

⚠️ **Important:** Always run `terraform plan` before `terraform apply` to review changes.

### Understanding the Generated Structure

When using `--path-pattern="{output}/{service}"`, Terraformer creates:

```
generated/
├── vpc/
│   ├── provider.tf
│   ├── vpc.tf
│   ├── outputs.tf
│   └── terraform.tfstate
├── subnet/
│   ├── provider.tf
│   ├── subnet.tf
│   ├── outputs.tf
│   └── terraform.tfstate
├── ec2_instance/
│   ├── provider.tf
│   ├── instance.tf
│   ├── outputs.tf
│   └── terraform.tfstate
└── iam/
    ├── provider.tf
    ├── iam_role.tf
    ├── iam_policy.tf
    ├── outputs.tf
    └── terraform.tfstate
```

Each service directory is independent and can be managed separately.

## Workspace Structure

The workspace contains generated Terraform configurations for the following AWS services in the `generated` directory:

- **Compute**: `ec2_instance`, `ecs`, `eks`, `lambda`, `elastic_beanstalk`
- **Networking**: `vpc`, `subnet`, `route_table`, `igw`, `nat`, `sg`, `alb`, `elb`
- **Storage**: `s3`, `ebs`, `efs`, `ecr`
- **Databases**: `rds`, `dynamodb`, `elasticache`, `docdb`
- **Security & Identity**: `iam`, `cognito`, `kms`, `secretsmanager`
- **CI/CD**: `codebuild`, `codepipeline`, `codecommit`, `codedeploy`
- **Monitoring & Logging**: `cloudwatch`, `logs`, `cloudtrail`, `xray`
- **CDN & Content Delivery**: `cloudfront`
- And many more...

## Working with the Generated Configuration

Each service directory contains:
- `provider.tf` - Provider configuration
- `*.tf` files - Resource definitions
- `terraform.tfstate` - Current state (if imported)
- `outputs.tf` - Output values

### Example: Working with IAM Resources

View IAM roles:
```bash
cat generated/iam/iam_role.tf
```

View IAM role policy attachments:
```bash
cat generated/iam/iam_role_policy_attachment.tf
```

Check IAM outputs:
```bash
cat generated/iam/outputs.tf
```

### Initialize and Plan

Before making any changes, initialize Terraform in each service directory:

```bash
cd generated/iam
terraform init
terraform plan
```

## Configuration Details

- **AWS Region**: `ap-southeast-1` (Singapore)
- **AWS Account ID**: `218927408484` (as seen in state files)
- **Terraform Provider**: AWS `~> 5.100.0`

## Key Resources

Some notable resources in this workspace include:

- IAM Roles: `AWSServiceRoleForSupport`, `AWSServiceRoleForTrustedAdvisor`, `CodeBuildRole`
- CloudWatch Log Groups: `/aws/codebuild/ecs-blue-buildproject`, `/aws/codebuild/ecs-green-buildproject`
- VPC: `vpc-081891cc539d845ea`
- Subnets: Multiple subnets in `ap-southeast-1a`, `ap-southeast-1b`, `ap-southeast-1c`

## Best Practices

### 1. Start Small
Don't import everything at once. Begin with:
```bash
terraformer import aws --resources=vpc --regions=ap-southeast-1
```

### 2. Use Specific Resources
Instead of `--resources="*"`, specify what you need:
```bash
terraformer import aws \
  --resources=vpc,subnet,sg,ec2_instance \
  --regions=ap-southeast-1
```

### 3. Review Before Applying
Always check generated files:
```bash
cd generated/vpc
terraform plan  # Review what would change
# Only apply if plan looks correct
terraform apply
```

### 4. Organize by Environment
Use path patterns to organize:
```bash
terraformer import aws \
  --resources=vpc,subnet \
  --path-output=environments/production \
  --path-pattern="{output}/{service}"
```

### 5. Use Filters for Large Accounts
Filter by tags or IDs to reduce scope:
```bash
terraformer import aws \
  --resources=ec2_instance \
  --filter="ec2_instance=tags.Environment:production" \
  --regions=ap-southeast-1
```

## Troubleshooting

### Error: "no such file or directory" for plugins

If you see:
```
open /home/wush/.terraform.d/plugins/linux_amd64: no such file or directory
```

This means the Terraform provider plugin is not installed. Follow the [Install Terraform Providers](#install-terraform-providers) section above.

### Error: Provider version conflicts

Ensure your `versions.tf` matches the provider version used in generated files. This workspace uses AWS provider `~> 5.100.0`.

### Importing takes too long

Start with specific resources instead of using `--resources=*`. Import incrementally:
1. Start with VPC and networking
2. Then compute resources
3. Finally, databases and other services

### Generated files are too large

Use filters to limit scope:
```bash
# Only import resources with specific tag
terraformer import aws \
  --resources=ec2_instance \
  --filter="ec2_instance=tags.ManagedBy:terraform" \
  --regions=ap-southeast-1
```

### Connect flag causes errors

If `--connect=true` causes import failures, use `--connect=false` and manually add references later:
```bash
terraformer import aws \
  --resources=vpc,subnet \
  --connect=false \
  --regions=ap-southeast-1
```

## Additional Resources

- [Terraformer Documentation](https://github.com/GoogleCloudPlatform/terraformer)
- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS CLI Documentation](https://docs.aws.amazon.com/cli/)
- [Terraform Provider Configuration](https://www.terraform.io/docs/configuration/providers.html)
